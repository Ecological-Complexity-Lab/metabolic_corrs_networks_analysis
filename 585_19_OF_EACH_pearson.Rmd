---
title: "585_analysis"
output: html_notebook
---

 needed packages:
```{r}
library(tidyverse)
library(boot)
library(readxl)
library(Hmisc)
library(ggplot2)
library(igraph)
library(data.table)
library(reshape2)
library(dplyr)

```

1.importing the data after filtering and grouping, adjusting it 
2.transpose each df and turning it into a matrix in order to adjust it and later use rcorr() 



```{r}
set_tbl<-read_csv("unique_19_of_each.csv")

set_tbl[,2:203][set_tbl[,2:203 ]==0]<- NA

#585_1
WT_set_tbl <-set_tbl[,59:77] %>%cbind(set_tbl$cluster)
evo_set_tbl<-set_tbl[,78:96] %>%cbind(set_tbl$cluster)
evoWT_set_tbl<-set_tbl[,2:20] %>%cbind(set_tbl$cluster)
unevo_set_tbl<-set_tbl[,40:58] %>%cbind(set_tbl$cluster)
mut_set_tbl<-set_tbl[,21:39] %>%cbind(set_tbl$cluster)

#585_2
WT_set_tbl <-set_tbl[,173:191] %>%cbind(set_tbl$cluster)
evo_set_tbl<-set_tbl[,116:134] %>%cbind(set_tbl$cluster)
evoWT_set_tbl<-set_tbl[,97:115] %>%cbind(set_tbl$cluster)
unevo_set_tbl<-set_tbl[,154:172] %>%cbind(set_tbl$cluster)
mut_set_tbl<-set_tbl[,135:153] %>%cbind(set_tbl$cluster)


WT_set_tbl <-WT_set_tbl %>% tibble::column_to_rownames(var="set_tbl$cluster")%>%data.matrix()%>%t()
evo_set_tbl <-evo_set_tbl %>% tibble::column_to_rownames(var="set_tbl$cluster")%>%data.matrix()%>%t()
unevo_set_tbl <-unevo_set_tbl %>% tibble::column_to_rownames(var="set_tbl$cluster")%>%data.matrix()%>%t()
evoWT_set_tbl <-evoWT_set_tbl %>% tibble::column_to_rownames(var="set_tbl$cluster")%>%data.matrix()%>%t()
mut_set_tbl <-mut_set_tbl %>% tibble::column_to_rownames(var="set_tbl$cluster")%>%data.matrix()%>%t()


```

amounts of SAM and meth

```{r}
mean_sd_meth_SAM <- data.frame(matrix(c(mean(WT_set_tbl[,"Cluster_04805789-meth"]),sd(WT_set_tbl[,"Cluster_04805789-meth"]),mean(WT_set_tbl[,"Cluster_083547"]),sd(WT_set_tbl[,"Cluster_083547"]),mean(unevo_set_tbl[,"Cluster_04805789-meth"]),sd(unevo_set_tbl[,"Cluster_04805789-meth"]),mean(unevo_set_tbl[,"Cluster_083547"]),sd(unevo_set_tbl[,"Cluster_083547"]),mean(evo_set_tbl[,"Cluster_04805789-meth"]),sd(evo_set_tbl[,"Cluster_04805789-meth"]),mean(evo_set_tbl[,"Cluster_083547"]),sd(evo_set_tbl[,"Cluster_083547"]),mean(evoWT_set_tbl[,"Cluster_04805789-meth"]),sd(evoWT_set_tbl[,"Cluster_04805789-meth"]),mean(evoWT_set_tbl[,"Cluster_083547"]),sd(evoWT_set_tbl[,"Cluster_083547"]),mean(mut_set_tbl[,"Cluster_04805789-meth"]),sd(mut_set_tbl[,"Cluster_04805789-meth"]),mean(mut_set_tbl[,"Cluster_083547"]),sd(mut_set_tbl[,"Cluster_083547"])), nrow= 5, ncol=4, byrow = TRUE))%>%`colnames<-`(c("meth_mean","meth_sd", "SAM_mean", "SAM_sd"))%>%add_column(bacteria_type = c("WT","unevo","evo","evoWT","mut"))



ggplot(mean_sd_meth_SAM, aes(x=bacteria_type, y=meth_mean)) +
  geom_bar(position=position_dodge(), stat="identity",fill="lightblue",
           colour='black') +
  geom_errorbar(aes(ymin=meth_mean-meth_sd, ymax=meth_mean+meth_sd), width=.2)+labs(title="Amount of methionine ", x="Bacteria type", y="Amount")+theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +scale_x_discrete(limits = c("WT", "unevo", "evo", "evoWT","mut"))


ggplot(mean_sd_meth_SAM, aes(x=bacteria_type, y=SAM_mean)) +
  geom_bar(position=position_dodge(), stat="identity",fill="lightblue",
           colour='black') +
  geom_errorbar(aes(ymin=SAM_mean-SAM_sd, ymax=SAM_mean+SAM_sd), width=.2)+labs(title="Amount of SAM ", x="Bacteria type", y="Amount")+theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +scale_x_discrete(limits = c("WT", "unevo", "evo", "evoWT","mut"))


```


1.creating the correlation matrix (spearman to reduce the effect of outliers). 
2.converting to long format
3.filter correlation 

```{r}
results_cor_WT <- rcorr(WT_set_tbl,type="pearson")
results_cor_evo <- rcorr(evo_set_tbl,type="pearson")
results_cor_unevo <- rcorr(unevo_set_tbl,type="pearson")
results_cor_evoWT <- rcorr(evoWT_set_tbl,type="pearson")
results_cor_mut <- rcorr(mut_set_tbl,type="pearson")

#check sam-meth corr
r <- results_cor_WT$r["Cluster_083547","Cluster_04805789-meth"]
p <- results_cor_mut$P["Cluster_083547","Cluster_04805789-meth"]

flattenCorrMatrix <- function(cormat, pmat,nmat) {
  ut <- upper.tri(cormat) 
  data.frame(
    M1 = rownames(cormat)[row(cormat)[ut]],
    M2 = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut],
    p_adj= p.adjust(pmat[ut], method = "fdr", n = length(pmat[ut])),
    n=nmat[ut]
  )}

#filter by n and p
filtering_corr <- function(results_cor){
  df1 <- flattenCorrMatrix(results_cor$r, results_cor$P, results_cor$n)
  df1 <- df1%>%filter(n>=10 & p<=0.05 & abs(cor)!=1) #change by relevant filtering 
  df_positive_p<-df1 %>% filter(cor > 0.000) 
  df_negative_p<-df1 %>% filter(cor < 0.000)  
  return(list(df1,df_positive_p,df_negative_p))
}

WT_pos_and_neg_p <-filtering_corr(results_cor_WT)
WT_pos_and_neg_p <- mapply(cbind, WT_pos_and_neg_p, "experiment"="WT", SIMPLIFY=F)
WT_P_r <- WT_pos_and_neg_p[[1]]
WT_positive_p<-  WT_pos_and_neg_p[[2]]
WT_negative_p <- WT_pos_and_neg_p[[3]]

mut_pos_and_neg_p <-filtering_corr(results_cor_mut)
mut_pos_and_neg_p <- mapply(cbind, mut_pos_and_neg_p, "experiment"="mut", SIMPLIFY=F)
mut_P_r <- mut_pos_and_neg_p[[1]]
mut_positive_p<-  mut_pos_and_neg_p[[2]]
mut_negative_p <- mut_pos_and_neg_p[[3]]

evo_pos_and_neg_p <-filtering_corr(results_cor_evo)
evo_pos_and_neg_p <- mapply(cbind, evo_pos_and_neg_p, "experiment"="evo", SIMPLIFY=F)
evo_P_r <- evo_pos_and_neg_p[[1]]
evo_positive_p<-  evo_pos_and_neg_p[[2]]
evo_negative_p <- evo_pos_and_neg_p[[3]]

unevo_pos_and_neg_p <-filtering_corr(results_cor_unevo)
unevo_pos_and_neg_p <- mapply(cbind, unevo_pos_and_neg_p, "experiment"="unevo", SIMPLIFY=F)
unevo_P_r <- unevo_pos_and_neg_p[[1]]
unevo_positive_p<-  unevo_pos_and_neg_p[[2]]
unevo_negative_p <- unevo_pos_and_neg_p[[3]]

evoWT_pos_and_neg_p <-filtering_corr(results_cor_evoWT)
evoWT_pos_and_neg_p <-mapply(cbind, evoWT_pos_and_neg_p, "experiment"="evoWT", SIMPLIFY=F) 
evoWT_P_r <- evoWT_pos_and_neg_p[[1]]
evoWT_positive_p<-  evoWT_pos_and_neg_p[[2]]
evoWT_negative_p <- evoWT_pos_and_neg_p[[3]]


# Bind the three experiments to a single data frame
all_together<-rbind(evo_P_r,unevo_P_r,WT_P_r,evoWT_P_r,mut_P_r) 
all_together_positive_p<-rbind(WT_positive_p, evo_positive_p, unevo_positive_p,evoWT_positive_p,mut_positive_p)
all_together_negative_p<-rbind(WT_negative_p, evo_negative_p, unevo_negative_p,evoWT_negative_p,mut_negative_p)

amount_of_cor <- data.frame(matrix(c(nrow(WT_positive_p),nrow(WT_negative_p),nrow(unevo_positive_p),nrow(unevo_negative_p),nrow(evo_positive_p),nrow(evo_negative_p),nrow(evoWT_positive_p),nrow(evoWT_negative_p),nrow(mut_positive_p),nrow(mut_negative_p)), nrow= 5, ncol=2, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("pos","neg"))

amount_of_cor_long <- melt(t(amount_of_cor))

amount_of_cor_plot <- ggplot(data=amount_of_cor_long, aes(x=Var2, y=value, fill=Var1)) +geom_bar(stat="identity", position=position_dodge())+labs(title="585_1-Positive and negative correlations ", x="bacteria type", y="Count")+ guides(fill=guide_legend(title="corr"))
amount_of_cor_plot


#png("my_plots.png", res=300)

```

plot the data
```{r}
positive_p_cor_plot<-all_together_positive_p %>% ggplot(aes(x=cor,fill=experiment)) + geom_histogram(color="black",fill="white", alpha=0.9,bins = 50) +facet_grid(. ~ experiment) + labs(title="Positive correlations ", x="cor", y="Count")
positive_p_cor_plot

negative_p_cor_plot<-all_together_negative_p %>% ggplot(aes(x=cor,fill=experiment)) + geom_histogram(color="black",fill="white", alpha=0.7,bins = 50) +facet_grid(. ~ experiment) + labs(title="Negative correlations", x="cor", y="Count")
negative_p_cor_plot

p_value_plot<-all_together %>% ggplot(aes(x=p,fill=experiment)) + geom_histogram(color="black", alpha=0.7) +facet_grid(. ~ experiment) +geom_vline(aes(xintercept=0.05),linetype="dashed") + labs(title="P-value distribution", x="p-value", y="Count")
p_value_plot

```

create igraph objects
```{r}
create_igraph <- function(df){
  before_igraph <- df%>% dplyr::select(from=M1, to=M2, weight=cor)
  igraph <-igraph::graph.data.frame(before_igraph ,directed=F) }

evo_negative_p_igraph_df <- create_igraph(evo_negative_p)
evo_positive_p_igraph_df <-create_igraph(evo_positive_p) 

unevo_negative_p_igraph_df <-create_igraph(unevo_negative_p) 
unevo_positive_p_igraph_df <-create_igraph(unevo_positive_p) 

WT_negative_p_igraph_df <- create_igraph(WT_negative_p)
WT_positive_p_igraph_df <- create_igraph(WT_positive_p)

evoWT_negative_p_igraph_df <- create_igraph(evoWT_negative_p)
evoWT_positive_p_igraph_df <-create_igraph( evoWT_positive_p) 

mut_negative_p_igraph_df <- create_igraph(mut_negative_p)
mut_positive_p_igraph_df <-create_igraph(mut_positive_p) 

```

density of the networks

```{r}
density_thresholds <- function(igraph){
  density <- c()
  if (E(igraph)$weight[1]<0){
    threshold <- seq(0,-1,by=-0.01)
    for (i in threshold){
      sgdf.copy <- delete.edges(igraph, which(E(igraph)$weight>(i)))
      den <- edge_density(sgdf.copy)
      density <-append(density,den)} 
  }else{
    threshold <- seq(0,1,by=0.01)
    for (i in threshold){
      sgdf.copy <- delete.edges(igraph, which(E(igraph)$weight<(i)))
      den <- edge_density(sgdf.copy)
      density <-append(density,den)  
    }}
  return(density)}

threshold <- seq(0,1,by=0.01)
evo <-density_thresholds(evo_positive_p_igraph_df)
unevo <-density_thresholds(unevo_positive_p_igraph_df)
evoWT <-density_thresholds(evoWT_positive_p_igraph_df)
WT <-density_thresholds(WT_positive_p_igraph_df)
mut <-density_thresholds(mut_positive_p_igraph_df)

den_pos <- data.frame(threshold,evo,evoWT,unevo,WT,mut)
library(reshape2)
long <- melt(den_pos, id.vars <- "threshold")

dens_thr_pos_plot<-long %>% ggplot(aes(x=threshold,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-positive", x="threshold", y="density")
dens_thr_pos_plot

threshold_neg <- seq(0,-1,by=-0.01)
evo <-density_thresholds(evo_negative_p_igraph_df)
unevo <-density_thresholds(unevo_negative_p_igraph_df)
evoWT <-density_thresholds(evoWT_negative_p_igraph_df)
WT <-density_thresholds(WT_negative_p_igraph_df)
mut <-density_thresholds(mut_negative_p_igraph_df)

den_neg <- data.frame(threshold_neg,evo,evoWT,unevo,WT,mut)
long_neg <- melt(den_neg, id.vars <- "threshold_neg")

dens_thr_neg_plot<-long_neg %>% ggplot(aes(x=threshold_neg,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-negative", x="threshold", y="density")
dens_thr_neg_plot
```


intersect
```{r}
#first- save the igraphs (in differents names) of the data set the we used already-

WT_positive_p_1 <- WT_positive_p
WT_negative_p_1 <- WT_negative_p

evoWT_positive_p_1 <- evoWT_positive_p
evoWT_negative_p_1 <- evoWT_negative_p

evo_positive_p_1 <- evo_positive_p
evo_negative_p_1 <- evo_negative_p

unevo_positive_p_1 <- unevo_positive_p
unevo_negative_p_1 <- unevo_negative_p

mut_positive_p_1 <- mut_positive_p
mut_negative_p_1 <- mut_negative_p



#node degree in both networks and JACARD-skip to the relevant section

#then- run everything again on the other data-set
#next- find common corrs


common_corrs <- function(df1,df2){
common_1= bind_rows(list(df1, df2)) %>%
  group_by(M1, M2) %>%filter(n()>1) %>%
  summarise(cor= sum(cor)/2)
df_2_oppo <- setNames(df2,  c("M2", "M1", "cor"))
common_2= bind_rows(list(df1, df_2_oppo)) %>%
  group_by(M1, M2) %>%filter(n()>1) %>%
  summarise(cor= sum(cor)/2)
df_3=rbind(common_1,common_2)
  return(df_3)}

common_WT_pos <- common_corrs(WT_positive_p,WT_positive_p_1)
common_WT_neg <- common_corrs(WT_negative_p,WT_negative_p_1)

common_evoWT_pos <- common_corrs(evoWT_positive_p,evoWT_positive_p_1)
common_evoWT_neg <- common_corrs(evoWT_negative_p,evoWT_negative_p_1)

common_evo_pos <- common_corrs(evo_positive_p,evo_positive_p_1)
common_evo_neg <- common_corrs(evo_negative_p,evo_negative_p_1)

common_unevo_pos <- common_corrs(unevo_positive_p,unevo_positive_p_1)
common_unevo_neg <- common_corrs(unevo_negative_p,unevo_negative_p_1)

common_mut_pos <- common_corrs(mut_positive_p,mut_positive_p_1)
common_mut_neg <- common_corrs(mut_negative_p,mut_negative_p_1)


write.csv(common_WT_pos,"common_WT_pos.csv")
write.csv(common_WT_neg,"common_WT_neg.csv")

write.csv(common_evoWT_pos,"common_evoWT_pos.csv")
write.csv(common_evoWT_neg,"common_evoWT_neg.csv")

write.csv(common_evo_pos,"common_evo_pos.csv")
write.csv(common_evo_neg,"common_evo_neg.csv")

write.csv(common_unevo_pos,"common_unevo_pos.csv")
write.csv(common_unevo_neg,"common_unevo_neg.csv")

write.csv(common_mut_pos,"common_mut_pos.csv")
write.csv(common_mut_neg,"common_mut_neg.csv")

#if already did that- can strat from here!

common_WT_pos <- read.csv("common_WT_pos.csv")
common_WT_neg <- read.csv("common_WT_neg.csv")

common_evoWT_pos <- read.csv("common_evoWT_pos.csv")
common_evoWT_neg <- read.csv("common_evoWT_neg.csv")

common_evo_pos <- read.csv("common_evo_pos.csv")
common_evo_neg <- read.csv("common_evo_neg.csv")

common_unevo_pos <- read.csv("common_unevo_pos.csv")
common_unevo_neg <- read.csv("common_unevo_neg.csv")

common_mut_pos <- read.csv("common_mut_pos.csv")
common_mut_neg <- read.csv("common_mut_neg.csv")


```

sam and meth common corrs
```{r}

change_in_corrs <- function(common, ds_585_1, ds_585_2, metabolite){
cor_common <- filter(common, M1==metabolite|M2==metabolite)
cor_2 <- filter(ds_585_2, M1==metabolite|M2==metabolite)
cor_1 <- filter(ds_585_1, M1==metabolite|M2==metabolite)

result <- data.frame(matrix(c(nrow(cor_common),nrow(cor_1),nrow(cor_2)), ncol=3, byrow = TRUE)) %>%`colnames<-`(c("common","585_1","585_2"))
return (result)
}


#SAM meth common correlation
#positive
SAM <- rbind(change_in_corrs(common_WT_pos,WT_positive_p_1,WT_positive_p,"Cluster_083547"),change_in_corrs(common_unevo_pos,unevo_positive_p_1,unevo_positive_p,"Cluster_083547"),change_in_corrs(common_evo_pos,evo_positive_p_1,evo_positive_p,"Cluster_083547"),change_in_corrs(common_evoWT_pos,evoWT_positive_p_1,evoWT_positive_p,"Cluster_083547"),change_in_corrs(common_mut_pos,mut_positive_p_1,mut_positive_p,"Cluster_083547"))%>%`rownames<-`(c("WT","unevo","evo","evoWT","mut"))

meth_3 <- rbind(change_in_corrs(common_WT_pos,WT_positive_p_1,WT_positive_p,"Cluster_04805789-meth"
),change_in_corrs(common_unevo_pos,unevo_positive_p_1,unevo_positive_p,"Cluster_04805789-meth"),change_in_corrs(common_evo_pos,evo_positive_p_1,evo_positive_p,"Cluster_04805789-meth"),change_in_corrs(common_evoWT_pos,evoWT_positive_p_1,evoWT_positive_p,"Cluster_04805789-meth"),change_in_corrs(common_mut_pos,mut_positive_p_1,mut_positive_p,"Cluster_04805789-meth"))%>%`rownames<-`(c("WT","unevo","evo","evoWT","mut"))

#percentage of common between bacteria0 change according to what you need
common_between_SAM <- nrow((common_corrs(filter(common_evo_pos, M1=="Cluster_083547"|M2=="Cluster_083547"),filter(common_mut_pos, M1=="Cluster_083547"|M2=="Cluster_083547"))))/SAM["evo","common"]

common_between_meth <- nrow((common_corrs(filter(common_mut_pos, M1=="Cluster_04805789-meth"|M2=="Cluster_04805789-meth"),filter(common_evo_pos, M1=="Cluster_04805789-meth"|M2=="Cluster_04805789-meth"))))/meth_3["mut","common"]

#negative
SAM <- rbind(change_in_corrs(common_WT_neg,WT_negative_p_1,WT_negative_p,"Cluster_083547"),change_in_corrs(common_unevo_neg,unevo_negative_p_1,unevo_negative_p,"Cluster_083547"),change_in_corrs(common_evo_neg,evo_negative_p_1,evo_negative_p,"Cluster_083547"),change_in_corrs(common_evoWT_neg,evoWT_negative_p_1,evoWT_negative_p,"Cluster_083547"),change_in_corrs(common_mut_neg,mut_negative_p_1,mut_negative_p,"Cluster_083547"))%>%`rownames<-`(c("WT","unevo","evo","evoWT","mut"))

meth_3 <- rbind(change_in_corrs(common_WT_neg,WT_negative_p_1,WT_negative_p,"Cluster_04805789-meth"
),change_in_corrs(common_unevo_neg,unevo_negative_p_1,unevo_negative_p,"Cluster_04805789-meth"),change_in_corrs(common_evo_neg,evo_negative_p_1,evo_negative_p,"Cluster_04805789-meth"),change_in_corrs(common_evoWT_neg,evoWT_negative_p_1,evoWT_negative_p,"Cluster_04805789-meth"),change_in_corrs(common_mut_neg,mut_negative_p_1,mut_negative_p,"Cluster_04805789-meth"))%>%`rownames<-`(c("WT","unevo","evo","evoWT","mut"))

#plot
ggplot(data=melt(t(meth_3))%>%filter(Var1=="common"), aes(x=Var2, y=value, fill=Var1)) +geom_bar(stat="identity", position=position_dodge(),color="black", fill="darksalmon") +labs(title="Amount of common correlations ", x="Bacteria type", y="Amount")+theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))

#percentage of common between bacteria0 change according to what you need

common_between_SAM <- nrow((common_corrs(filter(common_mut_neg, M1=="Cluster_083547"|M2=="Cluster_083547"),filter(common_evoWT_neg, M1=="Cluster_083547"|M2=="Cluster_083547"))))/SAM["mut","common"]


common_between_meth <- nrow((common_corrs(filter(common_mut_neg, M1=="Cluster_04805789-meth"|M2=="Cluster_04805789-meth"),filter(common_evoWT_neg, M1=="Cluster_04805789-meth"|M2=="Cluster_04805789-meth"))))/meth_3["mut","common"]


```

plot common corrs

```{r}
#positive
amount_of_common_pos <- data.frame(matrix(c(nrow(WT_positive_p_1),nrow(WT_positive_p),nrow(common_WT_pos),nrow(unevo_positive_p_1),nrow(unevo_positive_p),nrow(common_unevo_pos),nrow(evo_positive_p_1),nrow(evo_positive_p),nrow(common_evo_pos),nrow(evoWT_positive_p_1),nrow(evoWT_positive_p),nrow(common_evoWT_pos),nrow(mut_positive_p_1),nrow(mut_positive_p),nrow(common_mut_pos)), ncol=3, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("585_1","585_2","common"))

amount_of_common_pos_long <- melt(t(amount_of_common_pos))

amount_of_common_plot <- ggplot(data=amount_of_common_pos_long, aes(x=Var1, y=value, fill=Var1)) +geom_bar(stat="identity", position=position_dodge())+facet_grid(. ~ Var2) +labs(title="amount of positive common corrs ", x="data_set", y="Count")+scale_fill_brewer(palette="Set2")+  theme(axis.text.x = element_text(angle = 45))
amount_of_common_plot



pre_of_common <- 
data.frame(matrix(c(nrow(common_WT_pos)/nrow(WT_positive_p_1),nrow(common_WT_pos)/nrow(WT_positive_p),nrow(common_unevo_pos)/nrow(unevo_positive_p_1),nrow(common_unevo_pos)/nrow(unevo_positive_p),nrow(common_evo_pos)/nrow(evo_positive_p_1),nrow(common_evo_pos)/nrow(evo_positive_p),nrow(common_evoWT_pos)/nrow(evoWT_positive_p_1),nrow(common_evoWT_pos)/nrow(evoWT_positive_p),nrow(common_mut_pos)/nrow(mut_positive_p_1),nrow(common_mut_pos)/nrow(mut_positive_p)), ncol=2, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("585_1","585_2"))

#negative
amount_of_common_neg<- data.frame(matrix(c(nrow(WT_negative_p_1),nrow(WT_negative_p),nrow(common_WT_neg),nrow(unevo_negative_p_1),nrow(unevo_negative_p),nrow(common_unevo_neg),nrow(evo_negative_p_1),nrow(evo_negative_p),nrow(common_evo_neg),nrow(evoWT_negative_p_1),nrow(evoWT_negative_p),nrow(common_evoWT_neg),nrow(mut_negative_p_1),nrow(mut_negative_p),nrow(common_mut_neg)), ncol=3, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("585_1","585_2","common"))

amount_of_common_neg_long <- melt(t(amount_of_common_neg))

amount_of_common_plot <- ggplot(data=amount_of_common_neg_long, aes(x=Var1, y=value, fill=Var1)) +geom_bar(stat="identity", position=position_dodge())+facet_grid(. ~ Var2) +labs(title="amount of negative common corrs ", x="data_set", y="Count")+scale_fill_brewer(palette="Set2")+  theme(axis.text.x = element_text(angle = 45))

amount_of_common_plot

ggsave("my_ts.png", width=6, height = 4)

pre_of_common <- 
data.frame(matrix(c(nrow(common_WT_neg)/nrow(WT_negative_p_1),nrow(common_WT_neg)/nrow(WT_negative_p),nrow(common_unevo_neg)/nrow(unevo_negative_p_1),nrow(common_unevo_neg)/nrow(unevo_negative_p),nrow(common_evo_neg)/nrow(evo_negative_p_1),nrow(common_evo_neg)/nrow(evo_negative_p),nrow(common_evoWT_neg)/nrow(evoWT_negative_p_1),nrow(common_evoWT_neg)/nrow(evoWT_negative_p),nrow(common_mut_neg)/nrow(mut_negative_p_1),nrow(common_mut_neg)/nrow(mut_negative_p)), ncol=2, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("585_1","585_2"))


#example- with few rows
df1 <- evoWT_positive_p[c(10:15),c(1:3)]
df2 <- evoWT_positive_p_1[c(13:18),c(1:3)]

common <- intersect(df1[,c(1:2)], df2[,c(1:2)])  
exa <- common_corrs(df1,df2)

#make sure that it counts opposite matches (7-6 for 6-7 for example)
M1 <- c(7,7,7,3,3)
M2 <- c(6,5,3,4,1)
cor <- c(0.3,0.4,0.3,0.4,0.4)
test_df1 <- data.frame(cbind(M1, M2,cor))

M1 <- c(6,7,3,4,2)
M2 <- c(7,5,3,3,1)
cor <- c(0.1,0.2,0.3,0.4,0.4)
test_df2 <- data.frame(cbind(M1, M2,cor))

comdneg <- common_corrs(test_df1,test_df2)
d <- intersect(test_df1[,c(1:2)],test_df2[,c(1:2)])


```


create igraph objects for common
```{r}
create_igraph <- function(df){
  before_igraph <- df%>% dplyr::select(from=M1, to=M2, weight=cor)
  igraph <-igraph::graph.data.frame(before_igraph ,directed=F) }


evo_negative_p_igraph_df <- create_igraph(common_evo_neg)
evo_positive_p_igraph_df <-create_igraph(common_evo_pos) 

unevo_negative_p_igraph_df <-create_igraph(common_unevo_neg) 
unevo_positive_p_igraph_df <-create_igraph(common_unevo_pos) 

WT_negative_p_igraph_df <- create_igraph(common_WT_neg)
WT_positive_p_igraph_df <- create_igraph(common_WT_pos)

evoWT_negative_p_igraph_df <- create_igraph(common_evoWT_neg)
evoWT_positive_p_igraph_df <-create_igraph( common_evoWT_pos) 

mut_negative_p_igraph_df <- create_igraph(common_mut_neg)
mut_positive_p_igraph_df <-create_igraph(common_mut_pos) 


amount_of_v_and_e <- 
data.frame(matrix(c(length(V(WT_positive_p_igraph_df)),length(E(WT_positive_p_igraph_df)),length(V(WT_negative_p_igraph_df)),length(E(WT_negative_p_igraph_df)),length(V(unevo_positive_p_igraph_df)),length(E(unevo_positive_p_igraph_df)),length(V(unevo_negative_p_igraph_df)),length(E(unevo_negative_p_igraph_df)),length(V(evo_positive_p_igraph_df)),length(E(evo_positive_p_igraph_df)),length(V(evo_negative_p_igraph_df)),length(E(evo_negative_p_igraph_df)),length(V(evoWT_positive_p_igraph_df)),length(E(evoWT_positive_p_igraph_df)),length(V(evoWT_negative_p_igraph_df)),length(E(evoWT_negative_p_igraph_df)),length(V(mut_positive_p_igraph_df)),length(E(mut_positive_p_igraph_df)),length(V(mut_negative_p_igraph_df)),length(E(mut_negative_p_igraph_df))), ncol=4, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`(c("V_pos","E_pos","V_neg","E_neg"))

library(gridExtra)

png("test.png",res=100)
p<-tableGrob(amount_of_v_and_e)
grid.arrange(p)
dev.off()

```

density of the networks- common

```{r}
density_thresholds <- function(igraph){
  density <- c()
  if (E(igraph)$weight[1]<0){
    threshold <- seq(0,-1,by=-0.01)
    for (i in threshold){
      sgdf.copy <- delete_edges(igraph, which(E(igraph)$weight>(i)))
      den <- edge_density(sgdf.copy)
      density <-append(density,den)} 
  }else{
    threshold <- seq(0,1,by=0.01)
    for (i in threshold){
      sgdf.copy <- delete_edges(igraph, which(E(igraph)$weight<(i)))
      den <- edge_density(sgdf.copy)
      density <-append(density,den)  
    }}
  return(density)}

threshold <- seq(0,1,by=0.01)
evo <-density_thresholds(evo_positive_p_igraph_df)
unevo <-density_thresholds(unevo_positive_p_igraph_df)
evoWT <-density_thresholds(evoWT_positive_p_igraph_df)
WT <-density_thresholds(WT_positive_p_igraph_df)
mut <-density_thresholds(mut_positive_p_igraph_df)

den_pos <- data.frame(threshold,evo,evoWT,unevo,WT,mut)
library(reshape2)
long <- melt(den_pos, id.vars <- "threshold")

#rate of change
long$roc <- with(long, ave(value, variable, 
              FUN = function(x){c(NA_real_, c(diff(x), 0)/x)[seq_along(x)] * 100}))

dt <- as.data.table(long)
dt <-  dt[ , .(threshold, change=100*(value-shift(value,1))/shift(value,1)), by=variable]



dens_thr_pos_plot<-long %>% ggplot(aes(x=threshold,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-positive", x="threshold", y="density")
dens_thr_pos_plot

png("dens_common_pos.png", res=300)
ggsave("dens_common_neg.png", width = 6, height = 4 )

threshold_neg <- seq(0,-1,by=-0.01)
evo <-density_thresholds(evo_negative_p_igraph_df)
unevo <-density_thresholds(unevo_negative_p_igraph_df)
evoWT <-density_thresholds(evoWT_negative_p_igraph_df)
WT <-density_thresholds(WT_negative_p_igraph_df)
mut <-density_thresholds(mut_negative_p_igraph_df)

den_neg <- data.frame(threshold_neg,evo,evoWT,unevo,WT,mut)
long_neg <- melt(den_neg, id.vars <- "threshold_neg")

dens_thr_neg_plot<-long_neg %>% ggplot(aes(x=threshold_neg,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-negative", x="threshold", y="density")
dens_thr_neg_plot


```

node degree in both networks 
```{r}
#start here after you have a df for each bacteria in each data set- evo_posivie_p and evo_positive_p_1 for example

#create igraph objects-

#585_1
evo_negative_p_igraph_df_1 <- create_igraph(evo_negative_p_1)
evo_positive_p_igraph_df_1 <-create_igraph(evo_positive_p_1) 

unevo_negative_p_igraph_df_1 <-create_igraph(unevo_negative_p_1) 
unevo_positive_p_igraph_df_1 <-create_igraph(unevo_positive_p_1) 

WT_negative_p_igraph_df_1 <- create_igraph(WT_negative_p_1)
WT_positive_p_igraph_df_1 <- create_igraph(WT_positive_p_1)

evoWT_negative_p_igraph_df_1 <- create_igraph(evoWT_negative_p_1)
evoWT_positive_p_igraph_df_1 <-create_igraph(evoWT_positive_p_1) 

mut_negative_p_igraph_df_1 <- create_igraph(mut_negative_p_1)
mut_positive_p_igraph_df_1 <-create_igraph(mut_positive_p_1) 

#585_2
evo_negative_p_igraph_df_2 <- create_igraph(evo_negative_p)
evo_positive_p_igraph_df_2 <-create_igraph(evo_positive_p) 

unevo_negative_p_igraph_df_2 <-create_igraph(unevo_negative_p) 
unevo_positive_p_igraph_df_2 <-create_igraph(unevo_positive_p) 

WT_negative_p_igraph_df_2 <- create_igraph(WT_negative_p)
WT_positive_p_igraph_df_2 <- create_igraph(WT_positive_p)

evoWT_negative_p_igraph_df_2 <- create_igraph(evoWT_negative_p)
evoWT_positive_p_igraph_df_2 <-create_igraph(evoWT_positive_p) 

mut_negative_p_igraph_df_2 <- create_igraph(mut_negative_p)
mut_positive_p_igraph_df_2 <-create_igraph(mut_positive_p) 


node_info <- function(igraph){
  df2 <-data.frame(
                   "degree"=c(degree(igraph,v = V(igraph),mode ="all",loops = FALSE,normalized = FALSE)))
  return(df2)}

#positive
evo_pos_node_info_1 <- node_info(evo_positive_p_igraph_df_1)
unevo_pos_node_info_1  <- node_info(unevo_positive_p_igraph_df_1)
evoWT_pos_node_info_1  <- node_info(evoWT_positive_p_igraph_df_1)
WT_pos_node_info_1 <- node_info(WT_positive_p_igraph_df_1)
mut_pos_node_info_1 <- node_info(mut_positive_p_igraph_df_1)

evo_pos_node_info_2 <- node_info(evo_positive_p_igraph_df_2)
unevo_pos_node_info_2  <- node_info(unevo_positive_p_igraph_df_2)
evoWT_pos_node_info_2  <- node_info(evoWT_positive_p_igraph_df_2)
WT_pos_node_info_2 <- node_info(WT_positive_p_igraph_df_2)
mut_pos_node_info_2 <- node_info(mut_positive_p_igraph_df_2)


#negative
evo_neg_node_info_1 <- node_info(evo_negative_p_igraph_df_1)
unevo_neg_node_info_1  <- node_info(unevo_negative_p_igraph_df_1)
evoWT_neg_node_info_1  <- node_info(evoWT_negative_p_igraph_df_1)
WT_neg_node_info_1 <- node_info(WT_negative_p_igraph_df_1)
mut_neg_node_info_1 <- node_info(mut_negative_p_igraph_df_1)

evo_neg_node_info_2 <- node_info(evo_negative_p_igraph_df_2)
unevo_neg_node_info_2  <- node_info(unevo_negative_p_igraph_df_2)
evoWT_neg_node_info_2  <- node_info(evoWT_negative_p_igraph_df_2)
WT_neg_node_info_2 <- node_info(WT_negative_p_igraph_df_2)
mut_neg_node_info_2 <- node_info(mut_negative_p_igraph_df_2)

MyMerge       <- function(x, y){
  df            <- merge(x, y, by= "row.names", all.x= T, all.y= T)
  rownames(df)  <- df$Row.names
  df$Row.names  <- NULL
  return(df)
}

deg<- Reduce(MyMerge, list(mut_neg_node_info_1, mut_neg_node_info_2))%>%
  `colnames<-`(c("set_585_1","set_585_2"))

degree_plot <- ggplot(deg, aes(x=set_585_1, y=set_585_2)) +
  geom_point(color = "darkcyan", size=1) +xlim(0,200)+ylim(0,200)
degree_plot
```

jaccard
```{r}

jaccard <- function(igraph_1,igraph_2){
set_1 <- as.data.frame(get.edgelist(igraph_1))%>% `colnames<-`(c("M1","M2"))
set_2 <- as.data.frame(get.edgelist(igraph_2))%>% `colnames<-`(c("M1","M2"))
results_jaccard <- data.frame("M"=c(), "jacc"=c())
for (v in V(igraph_1)$name){
  set_1_filt <- filter(set_1, M1==v | M2==v)%>%add_column(cor = 0)
  set_2_filt <- filter(set_2, M1==v | M2==v)%>%add_column(cor = 0)
  if (nrow(set_1_filt)>0 & nrow(set_2_filt)>0){
  common= common_corrs(set_1_filt,set_2_filt)
jacc <-nrow(common)/(nrow(set_1_filt)+nrow(set_2_filt)-nrow(common))
results_jaccard <- rbind(results_jaccard, data.frame("M"=v, "jacc"=jacc))
  }}
  return(results_jaccard)
}



#positive
evo_pos_jac <- jaccard(evo_positive_p_igraph_df_1,evo_positive_p_igraph_df_2)%>%add_column(experiment = "evo")
evoWT_pos_jac <- jaccard(evoWT_positive_p_igraph_df_1,evoWT_positive_p_igraph_df_2)%>%add_column(experiment = "evoWT")
WT_pos_jac <- jaccard(WT_positive_p_igraph_df_1,WT_positive_p_igraph_df_2)%>%add_column(experiment = "WT")
unevo_pos_jac <- jaccard(unevo_positive_p_igraph_df_1,unevo_positive_p_igraph_df_2)%>%add_column(experiment = "unevo")
mut_pos_jac <- jaccard(mut_positive_p_igraph_df_1,mut_positive_p_igraph_df_2)%>%add_column(experiment = "mut")

library(ggridges)

gasoline <- rbind(evo_pos_jac,evoWT_pos_jac,WT_pos_jac,unevo_pos_jac,mut_pos_jac)
gasoline  %>% ggplot(aes(jacc,experiment)) +
  geom_density_ridges(aes(fill=experiment),alpha=0.5) +
  scale_y_discrete(limits=rev) +
  labs(x="Jaccard index",y="Counts per bacteria type")+xlim(0, 1)


#negative
evo_neg_jac <- jaccard(evo_negative_p_igraph_df_1,evo_negative_p_igraph_df_2)%>%add_column(experiment = "evo")
evoWT_neg_jac <- jaccard(evoWT_negative_p_igraph_df_1,evoWT_negative_p_igraph_df_2)%>%add_column(experiment = "evoWT")
WT_neg_jac <- jaccard(WT_negative_p_igraph_df_1,WT_negative_p_igraph_df_2)%>%add_column(experiment = "WT")
unevo_neg_jac <- jaccard(unevo_negative_p_igraph_df_1,unevo_negative_p_igraph_df_2)%>%add_column(experiment = "unevo")
mut_neg_jac <- jaccard(mut_negative_p_igraph_df_1,mut_negative_p_igraph_df_2)%>%add_column(experiment = "mut")

gasoline1 <- rbind(evo_neg_jac,evoWT_neg_jac,WT_neg_jac,unevo_neg_jac,mut_neg_jac)
gasoline1  %>% ggplot(aes(jacc,experiment)) +
  geom_density_ridges(aes(fill=experiment),alpha=0.5) +
  scale_y_discrete(limits=rev) +
  labs(x="Jaccard index",y="Counts per bacteria type")+xlim(0, 1)

gasoline1  %>% ggplot(aes(jacc,experiment)) +
  geom_density_ridges(aes(fill=experiment),alpha=0.5) +
  scale_y_discrete(limits=rev) +
  labs(x="Jaccard index",y="Counts per bacteria type")
```

node info
```{r}

node_info <- function(igraph){
  eigen=eigen_centrality(igraph, directed = FALSE, scale = FALSE,weights = abs(E(igraph)$weight), options = arpack_defaults)
  df2 <-data.frame("CC"= c(transitivity(igraph,type = "local",vids = V(igraph),weights = abs(E(igraph)$weight),isolates="zero")),
                   "bet"=c(betweenness(igraph,v = V(igraph),directed = FALSE, weights = 1/abs(E(igraph)$weight),normalized =TRUE)),
                   "degree"=c(degree(igraph,v = V(igraph),mode ="all",loops = FALSE,normalized = F)),
                   "strength"=c(strength(igraph,vids = V(igraph),loops = FALSE)),
                   "eigen"=eigen$vector)
  return(df2)}



evo_pos_node_info <- node_info(evo_positive_p_igraph_df)
evo_neg_node_info <- node_info(evo_negative_p_igraph_df)

unevo_pos_node_info <- node_info(unevo_positive_p_igraph_df)
unevo_neg_node_info <- node_info(unevo_negative_p_igraph_df)

WT_pos_node_info <- node_info(WT_positive_p_igraph_df)
WT_neg_node_info <- node_info(WT_negative_p_igraph_df)

evoWT_pos_node_info <- node_info(evoWT_positive_p_igraph_df)
evoWT_neg_node_info <- node_info(evoWT_negative_p_igraph_df)

mut_pos_node_info <- node_info(mut_positive_p_igraph_df)
mut_neg_node_info <- node_info(mut_negative_p_igraph_df)

MyMerge       <- function(x, y){
  df            <- merge(x, y, by= "row.names", all.x= T, all.y= T)
  rownames(df)  <- df$Row.names
  df$Row.names  <- NULL
  return(df)
}

#positive
CC_pos_all<- Reduce(MyMerge, list(select(WT_pos_node_info,"CC"), select(unevo_pos_node_info,"CC"), select(evo_pos_node_info,"CC"), select(evoWT_pos_node_info,"CC"),select(mut_pos_node_info,"CC")))%>% 
  `colnames<-`(c("WT","unevo","evo","evoWT","mut")) 

bet_pos_all<- Reduce(MyMerge, list(select(evo_pos_node_info,"bet"), select(unevo_pos_node_info,"bet"), select(evoWT_pos_node_info,"bet"), select(WT_pos_node_info,"bet"),select(mut_pos_node_info,"bet")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

deg_pos_all<- Reduce(MyMerge, list(select(evo_pos_node_info,"degree"), select(unevo_pos_node_info,"degree"), select(evoWT_pos_node_info,"degree"), select(WT_pos_node_info,"degree"),select(mut_pos_node_info,"degree")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

strength_pos_all<- Reduce(MyMerge, list(select(evo_pos_node_info,"strength"), select(unevo_pos_node_info,"strength"), select(evoWT_pos_node_info,"strength"), select(WT_pos_node_info,"strength"),select(mut_pos_node_info,"strength")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

eigen_pos_all<- Reduce(MyMerge, list(select(evo_pos_node_info,"eigen"), select(unevo_pos_node_info,"eigen"), select(evoWT_pos_node_info,"eigen"), select(WT_pos_node_info,"eigen"),select(mut_pos_node_info,"eigen")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

#negative
CC_neg_all<- Reduce(MyMerge, list(select(WT_neg_node_info,"CC"), select(unevo_neg_node_info,"CC"), select(evo_neg_node_info,"CC"), select(evoWT_neg_node_info,"CC"),select(mut_neg_node_info,"CC")))%>% 
  `colnames<-`(c("WT","unevo","evo","evoWT","mut")) 

bet_neg_all<- Reduce(MyMerge, list(select(evo_neg_node_info,"bet"), select(unevo_neg_node_info,"bet"), select(evoWT_neg_node_info,"bet"), select(WT_neg_node_info,"bet"),select(mut_neg_node_info,"bet")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

deg_neg_all<- Reduce(MyMerge, list(select(evo_neg_node_info,"degree"), select(unevo_neg_node_info,"degree"), select(evoWT_neg_node_info,"degree"), select(WT_neg_node_info,"degree"),select(mut_neg_node_info,"degree")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

strength_neg_all<- Reduce(MyMerge, list(select(evo_neg_node_info,"strength"), select(unevo_neg_node_info,"strength"), select(evoWT_neg_node_info,"strength"), select(WT_neg_node_info,"strength"),select(mut_neg_node_info,"strength")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

eigen_neg_all<- Reduce(MyMerge, list(select(evo_neg_node_info,"eigen"), select(unevo_neg_node_info,"eigen"), select(evoWT_neg_node_info,"eigen"), select(WT_neg_node_info,"eigen"),select(mut_neg_node_info,"eigen")))%>%
  `colnames<-`(c("evo","unevo","evoWT","WT","mut"))

#distribution plots- change pos/neg

CC_plot<-CC_pos_all %>% tibble::rownames_to_column(var = "Row") %>%pivot_longer(-Row, names_to = "Name", values_to = "CC")%>% ggplot(aes(x=CC,fill=Name)) + geom_histogram( 
  color="black", alpha=0.7 ) +facet_grid(. ~ factor(Name, levels=c("WT", "unevo", "evo", "evoWT", "mut"))) + labs(title="Node CC distribution (positive)", x="node CC", y="Count")+ theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.3))
CC_plot

bet_plot<-bet_neg_all%>% tibble::rownames_to_column(var = "Row") %>%pivot_longer(-Row, names_to = "Name", values_to = "bet") %>% ggplot(aes(x=bet,fill=Name)) + geom_histogram( 
  color="black", alpha=0.7 ) +facet_grid(. ~ factor(Name, levels=c("WT", "unevo", "evo", "evoWT", "mut")))+ labs(title="Node betweenness distribution (negative)", x="node betweenness", y="Count")
bet_plot

degree_plot<-deg_neg_all %>% tibble::rownames_to_column(var = "Row") %>%pivot_longer(-Row, names_to = "Name", values_to = "degree")%>%ggplot(aes(x=degree,fill=Name)) + geom_histogram( 
  color="black", alpha=0.7 ) +facet_grid(. ~ factor(Name, levels=c("WT", "unevo", "evo", "evoWT", "mut"))) + labs(title="Node degree distribution (negative)", x="node degree", y="Count")+ theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.3))
degree_plot


strength_plot<-strength_neg_all%>% tibble::rownames_to_column(var = "Row") %>%pivot_longer(-Row, names_to = "Name", values_to = "strength") %>% ggplot(aes(x=strength,fill=Name)) + geom_histogram( 
  color="black", alpha=0.7 ) +facet_grid(. ~ factor(Name, levels=c("WT", "unevo", "evo", "evoWT", "mut"))) + labs(title="Node strength distribution (negative)", x="node strength", y="Count")
strength_plot

eigen_plot<-eigen_pos_all%>% tibble::rownames_to_column(var = "Row") %>%pivot_longer(-Row, names_to = "Name", values_to = "eigen") %>% ggplot(aes(x=eigen,fill=Name)) + geom_histogram( 
  color="black", alpha=0.7 ) +facet_grid(. ~ factor(Name, levels=c("WT", "unevo", "evo", "evoWT", "mut"))) + labs(title="Node eigen distribution (positive)", x="node eigen", y="Count")
eigen_plot


```

network hubs
```{r}
#positive
hub_score_WT_pos <- data.frame(hub_score= hub_score(WT_positive_p_igraph_df, weights=1/abs(E(WT_positive_p_igraph_df)$weight))$vector,
V = c(V(WT_positive_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_evo_pos <- data.frame(hub_score= hub_score(evo_positive_p_igraph_df, weights=1/abs(E(evo_positive_p_igraph_df)$weight))$vector,
V = c(V(evo_positive_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_evoWT_pos <- data.frame(hub_score= hub_score(evoWT_positive_p_igraph_df, weights=1/abs(E(evoWT_positive_p_igraph_df)$weight))$vector,
V = c(V(evoWT_positive_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_unevo_pos <- data.frame(hub_score= hub_score(unevo_positive_p_igraph_df, weights=1/abs(E(unevo_positive_p_igraph_df)$weight))$vector,
V = c(V(unevo_positive_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_mut_pos <- data.frame(hub_score= hub_score(mut_positive_p_igraph_df, weights=1/abs(E(mut_positive_p_igraph_df)$weight))$vector,
V = c(V(mut_positive_p_igraph_df)$name))%>% arrange(desc(hub_score))

#negative
hub_score_WT_neg <- data.frame(hub_score= hub_score(WT_negative_p_igraph_df, weights=1/abs(E(WT_negative_p_igraph_df)$weight))$vector,
V = c(V(WT_negative_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_evo_neg <- data.frame(hub_score= hub_score(evo_negative_p_igraph_df, weights=1/abs(E(evo_negative_p_igraph_df)$weight))$vector,
V = c(V(evo_negative_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_evoWT_neg <- data.frame(hub_score= hub_score(evoWT_negative_p_igraph_df, weights=1/abs(E(evoWT_negative_p_igraph_df)$weight))$vector,
V = c(V(evoWT_negative_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_unevo_neg <- data.frame(hub_score= hub_score(unevo_negative_p_igraph_df, weights=1/abs(E(unevo_negative_p_igraph_df)$weight))$vector,
V = c(V(unevo_negative_p_igraph_df)$name))%>% arrange(desc(hub_score))

hub_score_mut_neg <- data.frame(hub_score= hub_score(mut_negative_p_igraph_df, weights=1/abs(E(mut_negative_p_igraph_df)$weight))$vector,
V = c(V(mut_negative_p_igraph_df)$name))%>% arrange(desc(hub_score))


```

degree/ density (Tal's plot)
```{r}

density_vs_degree <- function(igraph,degree_df,bact){
  det <- c()
  degree=as.data.frame(na.omit(cbind(row.names(degree_df), degree_df[,bact])))
  degree$V2 <- as.numeric(degree$V2)
    #threshold <- seq(na.omit(max(degree$V2)),1,by=-1)
    threshold <- seq(170,1,by=-1)
    for (i in threshold){
      delete <- filter(degree,V2>i)
      sgdf.copy <- igraph - delete$V1
      if(length(V(sgdf.copy)>0)){
      den <- edge_density(sgdf.copy)
      det <-append(det,den)
    }else{
      break}}
det2 <- as.data.frame(cbind(threshold, det))
  return(det2)}


WT <-density_vs_degree(WT_positive_p_igraph_df,deg_pos_all,"WT") 
evo <-density_vs_degree(evo_positive_p_igraph_df,deg_pos_all,"evo") 
unevo <-density_vs_degree(unevo_positive_p_igraph_df,deg_pos_all,"unevo") 
evoWT <-density_vs_degree(evoWT_positive_p_igraph_df,deg_pos_all,"evoWT") 
mut <-density_vs_degree(mut_positive_p_igraph_df,deg_pos_all,"mut") 

threshold <- seq(170,1,by=-1)
den_pos <- data.frame("threshold"=threshold,"evo"=evo$det,"evoWT"=evoWT$det,"unevo"=unevo$det,"WT"=WT$det,"mut"=mut$det)
library(reshape2)
long <- melt(den_pos, id.vars <- "threshold")

dens_thr_pos_plot<-long %>% ggplot(aes(x=threshold,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-positive", x="Threshold", y="Density")+guides(color=guide_legend("Bacteria Type")) 
dens_thr_pos_plot


WT_neg <-density_vs_degree(WT_negative_p_igraph_df,deg_neg_all,"WT") 
evo_neg <-density_vs_degree(evo_negative_p_igraph_df,deg_neg_all,"evo") 
unevo_neg <-density_vs_degree(unevo_negative_p_igraph_df,deg_neg_all,"unevo") 
evoWT_neg <-density_vs_degree(evoWT_negative_p_igraph_df,deg_neg_all,"evoWT") 
mut_neg <-density_vs_degree(mut_negative_p_igraph_df,deg_neg_all,"mut")

threshold <- seq(170,1,by=-1)
den_neg <- data.frame("threshold"=threshold,"evo"=evo_neg$det,"evoWT"=evoWT_neg$det,"unevo"=unevo_neg$det,"WT"=WT_neg$det,"mut"=mut_neg$det)
long <- melt(den_neg, id.vars <- "threshold")

dens_thr_neg_plot<-long %>% ggplot(aes(x=threshold,y=value ,color=variable)) + geom_point( 
) +geom_line()+ labs(title="Density of the network with different thresholds-negative", x="Threshold", y="Density")+guides(color=guide_legend("Bacteria Type")) 
dens_thr_neg_plot

#plot for just one network- change pos/neg
mut_plot <- ggplot(mut_neg, aes(x=threshold,y=det)) + geom_point(color="darkred" 
) +geom_line()+ labs(title="mut",x="Threshold", y="Density")#+geom_smooth(color="blue")

evo_plot <- ggplot(evo_neg, aes(x=threshold,y=det)) + geom_point(color="darkred" 
) +geom_line()+ labs(title="evo",x="Threshold", y="Density")#+geom_smooth(color="blue")

evoWT_plot <- ggplot(evoWT_neg, aes(x=threshold,y=det)) + geom_point(color="darkred" 
) +geom_line()+ labs(title="evoWT", x="Threshold", y="Density")#+geom_smooth(color="blue")

WT_plot <- ggplot(WT_neg, aes(x=threshold,y=det)) + geom_point(color="darkred" 
) +geom_line()+ labs(title="WT", x="Threshold", y="Density")#+geom_smooth(color="blue")

unevo_plot <- ggplot(unevo_neg, aes(x=threshold,y=det)) + geom_point(color="darkred" 
) +geom_line()+ labs(title="unevo", x="Threshold", y="Density")#+geom_smooth(color="blue")


library(ggpubr)
library(grid)


figure <- ggarrange(WT_plot+ rremove("ylab") + rremove("xlab"),unevo_plot+ rremove("ylab") + rremove("xlab"),evo_plot + rremove("ylab") + rremove("xlab"), evoWT_plot + rremove("ylab") + rremove("xlab"), mut_plot + rremove("ylab") + rremove("xlab"), # remove axis labels from plots
                    labels = NULL,
                    ncol = 3, nrow = 2)
annotate_figure(figure, left = textGrob("Density", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Threshold", gp = gpar(cex = 1.3)),top = text_grob("Density of the network with different degree thresholds",  color = "black", face = "bold", size = 16))


```

infomap ecolgoy
```{r}
package.list=c("attempt", "cowplot", "igraph", "ggalluvial","magrittr","metafolio","tidyverse","vegan", "devtools")
loaded <-  package.list %in% .packages()
package.list <-  package.list[!loaded]
installed <-  package.list %in% .packages(TRUE)
if (!all(installed)) install.packages(package.list[!installed], repos="http://cran.rstudio.com/")

# Install infomapecology 
devtools::install_github('Ecological-Complexity-Lab/infomap_ecology_package', force=T)
library(infomapecology)

# Check the version.
packageDescription('infomapecology')


network_object <- create_monolayer_object(x=results_cor_WT$r, directed = F, bipartite = F)
infomap_object <- run_infomap_monolayer(network_object, infomap_executable='Infomap',
                                        flow_model = 'undirected',
                                        silent=T,trials=100, two_level=F, seed=123)



```


modularity
```{r}

#wt_pos_walk <- cluster_walktrap(WT_positive_p_igraph_df, weights=1/abs(E(WT_positive_p_igraph_df)$weight))
#modularity(WT_positive_p_igraph_df, membership(wt_pos_walk), weights=1/E(WT_positive_p_igraph_df)$weight)
#wt_pos_walk_df <- as.data.frame(sizes(wt_pos_walk))
set.seed(1);wt_pos_infomap <- cluster_infomap(WT_positive_p_igraph_df, e.weights=1/abs(E(WT_positive_p_igraph_df)$weight))
wt_pos_infomap_df <- as.data.frame(sizes(wt_pos_infomap))
modularity(wt_pos_infomap)

set.seed(1);evo_pos_infomap <- cluster_infomap(evo_positive_p_igraph_df, e.weights=1/abs(E(evo_positive_p_igraph_df)$weight))
evo_pos_infomap_df <- as.data.frame(sizes(evo_pos_infomap))
modularity(evo_pos_infomap)


set.seed(1);unevo_pos_infomap <- cluster_infomap(unevo_positive_p_igraph_df, e.weights=1/abs(E(unevo_positive_p_igraph_df)$weight))
unevo_pos_infomap_df <- as.data.frame(sizes(unevo_pos_infomap))
modularity(unevo_pos_infomap)

set.seed(1);evoWT_pos_infomap <- cluster_infomap(evoWT_positive_p_igraph_df, e.weights=1/abs(E(evoWT_positive_p_igraph_df)$weight))
evoWT_pos_infomap_df <- as.data.frame(sizes(evoWT_pos_infomap))
modularity(evoWT_pos_infomap)

set.seed(1);mut_pos_infomap <- cluster_infomap(mut_positive_p_igraph_df, e.weights=1/abs(E(mut_positive_p_igraph_df)$weight))
mut_pos_infomap_df <- as.data.frame(sizes(mut_pos_infomap))
modularity(mut_pos_infomap)

ggplot(mut_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="Size of modules", x="Module number", y="Module size")+guides(x=guide_axis(angle = 45))+theme(axis.title.x = element_text( size=14),
axis.title.y = element_text( size=14),plot.title= element_text( size=16, face="bold"))


mut_plot <- ggplot(mut_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="mut", x="Module number", y="Module size")+theme(axis.title.x = element_text(size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(mut_pos_infomap_df), by=5))

evo_plot <- ggplot(evo_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="evo", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(evo_pos_infomap_df), by=5))


evoWT_plot <- ggplot(evoWT_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="evoWT", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(evoWT_pos_infomap_df), by=5))

WT_plot <- ggplot(wt_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="WT", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(wt_pos_infomap_df), by=5))

unevo_plot <- ggplot(unevo_pos_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="unevo", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(unevo_pos_infomap_df), by=5))

figure <- ggarrange(WT_plot+ rremove("ylab") + rremove("xlab"),unevo_plot+ rremove("ylab") + rremove("xlab"),evo_plot + rremove("ylab") + rremove("xlab"), evoWT_plot + rremove("ylab") + rremove("xlab"), mut_plot + rremove("ylab") + rremove("xlab"), # remove axis labels from plots
                    labels = NULL,
                    ncol = 3, nrow = 2)
annotate_figure(figure, left = textGrob("Module size", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Module number", gp = gpar(cex = 1.3)),top = text_grob("Size of modules",  color = "black", face = "bold", size = 16))


ggsave("file.pdf",figure, width = 10,height = 6,)



#negative
set.seed(1);wt_neg_infomap <- cluster_infomap(WT_negative_p_igraph_df, e.weights=1/abs(E(WT_negative_p_igraph_df)$weight))
wt_neg_infomap_df <- as.data.frame(sizes(wt_neg_infomap))
modularity(wt_neg_infomap)


set.seed(1);evo_neg_infomap <- cluster_infomap(evo_negative_p_igraph_df, e.weights=1/abs(E(evo_negative_p_igraph_df)$weight))
evo_neg_infomap_df <- as.data.frame(sizes(evo_neg_infomap))
modularity(evo_neg_infomap)


set.seed(1);unevo_neg_infomap <- cluster_infomap(unevo_negative_p_igraph_df, e.weights=1/abs(E(unevo_negative_p_igraph_df)$weight))
unevo_neg_infomap_df <- as.data.frame(sizes(unevo_neg_infomap))
modularity(unevo_neg_infomap)

set.seed(1);evoWT_neg_infomap <- cluster_infomap(evoWT_negative_p_igraph_df, e.weights=1/abs(E(evoWT_negative_p_igraph_df)$weight))
evoWT_neg_infomap_df <- as.data.frame(sizes(evoWT_neg_infomap))
modularity(evoWT_neg_infomap)

set.seed(1);mut_neg_infomap <- cluster_infomap(mut_negative_p_igraph_df, e.weights=1/abs(E(mut_negative_p_igraph_df)$weight))
mut_neg_infomap_df <- as.data.frame(sizes(mut_neg_infomap))
modularity(mut_neg_infomap)


mut_plot <- ggplot(mut_neg_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="mut", x="Module number", y="Module size")+theme(axis.title.x = element_text(size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(mut_neg_infomap_df), by=5))

evo_plot <- ggplot(evo_neg_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="evo", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(evo_neg_infomap_df), by=5))


evoWT_plot <- ggplot(evoWT_neg_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="evoWT", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(evoWT_neg_infomap_df), by=5))

WT_plot <- ggplot(wt_neg_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="WT", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(wt_neg_infomap_df), by=5))

unevo_plot <- ggplot(unevo_neg_infomap_df, aes(x=Community.sizes, y=Freq)) +
    geom_col(fill="lightblue",color="black")+ labs(title="unevo", x="Module number", y="Module size")+theme(axis.title.x = element_text( size=14))+theme_minimal()+scale_x_discrete(breaks=seq(1,nrow(unevo_neg_infomap_df), by=5))

figure <- ggarrange(WT_plot+ rremove("ylab") + rremove("xlab"),unevo_plot+ rremove("ylab") + rremove("xlab"),evo_plot + rremove("ylab") + rremove("xlab"), evoWT_plot + rremove("ylab") + rremove("xlab"), mut_plot + rremove("ylab") + rremove("xlab"), # remove axis labels from plots
                    labels = NULL,
                    ncol = 3, nrow = 2)
annotate_figure(figure, left = textGrob("Module size", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Module number", gp = gpar(cex = 1.3)),top = text_grob("Size of modules",  color = "black", face = "bold", size = 16))


ggsave("file.png",figure, width = 10,height = 6,)


#delte?
plot(evo_negative_p_igraph_df, vertex.label = '', vertex.size = 5)
set.seed(1);wc <- evo_neg_infomap <- cluster_infomap(evo_negative_p_igraph_df, e.weights=1/abs(E(evo_negative_p_igraph_df)$weight))

V(evo_positive_p_igraph_df)$community <-  membership(wc)

g_grouped = evo_positive_p_igraph_df

for(i in unique(V(evo_positive_p_igraph_df)$community)){
  groupV = which(V(evo_positive_p_igraph_df)$community == i)
  g_grouped = add_edges(g_grouped, combn(groupV, 2), attr=list(weight = 2))
}

l <- layout_nicely(g_grouped)

plot( wc,evo_positive_p_igraph_df, layout = l, vertex.label = '', vertex.size = 5, edge.width = .1)




```

hubs in modules
```{r}
#positive
community_WT <- wt_pos_infomap$membership; V_WT <- as_ids(V(WT_positive_p_igraph_df)); vcom_WT <- data.frame("community"=community_WT, "V"=V_WT)
hubs_in_modu_WT_pos <- inner_join(hub_score_WT_pos,vcom_WT, by ="V")

community_evo <- evo_pos_infomap$membership; V_evo <- as_ids(V(evo_positive_p_igraph_df)); vcom_evo <- data.frame("community"=community_evo, "V"=V_evo)
hubs_in_modu_evo_pos <- inner_join(hub_score_evo_pos,vcom_evo, by ="V")

community_evoWT <- evoWT_pos_infomap$membership; V_evoWT <- as_ids(V(evoWT_positive_p_igraph_df)); vcom_evoWT <- data.frame("community"=community_evoWT, "V"=V_evoWT)
hubs_in_modu_evoWT_pos <- inner_join(hub_score_evoWT_pos,vcom_evoWT, by ="V")

community_unevo <- unevo_pos_infomap$membership; V_unevo <- as_ids(V(unevo_positive_p_igraph_df)); vcom_unevo <- data.frame("community"=community_unevo, "V"=V_unevo)
hubs_in_modu_unevo_pos <- inner_join(hub_score_unevo_pos,vcom_unevo, by ="V")

community_mut <- mut_pos_infomap$membership; V_mut <- as_ids(V(mut_positive_p_igraph_df)); vcom_mut <- data.frame("community"=community_mut, "V"=V_mut)
hubs_in_modu_mut_pos <- inner_join(hub_score_mut_pos,vcom_mut, by ="V")

#negative
community_WT_neg <- wt_neg_infomap$membership; V_WT_neg <- as_ids(V(WT_negative_p_igraph_df)); vcom_WT_neg <- data.frame("community"=community_WT_neg, "V"=V_WT_neg)
hubs_in_modu_WT_neg <- inner_join(hub_score_WT_neg,vcom_WT_neg, by ="V")

community_evo_neg <- evo_neg_infomap$membership; V_evo_neg <- as_ids(V(evo_negative_p_igraph_df)); vcom_evo_neg <- data.frame("community"=community_evo_neg, "V"=V_evo_neg)
hubs_in_modu_evo_neg <- inner_join(hub_score_evo_neg,vcom_evo_neg, by ="V")

community_evoWT_neg <- evoWT_neg_infomap$membership; V_evoWT_neg <- as_ids(V(evoWT_negative_p_igraph_df)); vcom_evoWT_neg <- data.frame("community"=community_evoWT_neg, "V"=V_evoWT_neg)
hubs_in_modu_evoWT_neg <- inner_join(hub_score_evoWT_neg,vcom_evoWT_neg, by ="V")

community_unevo_neg <- unevo_neg_infomap$membership; V_unevo_neg <- as_ids(V(unevo_negative_p_igraph_df)); vcom_unevo_neg <- data.frame("community"=community_unevo_neg, "V"=V_unevo_neg)
hubs_in_modu_unevo_neg <- inner_join(hub_score_unevo_neg,vcom_unevo_neg, by ="V")

community_mut_neg <- mut_neg_infomap$membership; V_mut_neg <- as_ids(V(mut_negative_p_igraph_df)); vcom_mut_neg <- data.frame("community"=community_mut_neg, "V"=V_mut_neg)
hubs_in_modu_mut_neg <- inner_join(hub_score_mut_neg,vcom_mut_neg, by ="V")

#core of the big module-between pos and neg


#is the big module the same in pos and neg for each bacteria type?
big_mod_WT_pos <- filter(hubs_in_modu_WT_pos, community==1)
big_mod_WT_neg <- filter(hubs_in_modu_WT_neg, community==1)
core_mod_WT <-  bind_rows(list(big_mod_WT_pos,big_mod_WT_neg)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)

big_mod_evo_pos <- filter(hubs_in_modu_evo_pos, community==1)
big_mod_evo_neg_1 <- filter(hubs_in_modu_evo_neg, community==1)
big_mod_evo_neg_2 <- filter(hubs_in_modu_evo_neg, community==2)

core_mod_evo_1 <-  bind_rows(list(big_mod_evo_pos,big_mod_evo_neg_1)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)
core_mod_evo_2 <-  bind_rows(list(big_mod_evo_pos,big_mod_evo_neg_2)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)

big_mod_evoWT_pos <- filter(hubs_in_modu_evoWT_pos, community==1)
big_mod_evoWT_neg_1 <- filter(hubs_in_modu_evoWT_neg, community==1)
big_mod_evoWT_neg_2 <- filter(hubs_in_modu_evoWT_neg, community==2)

core_mod_evoWT_1 <-  bind_rows(list(big_mod_evoWT_pos,big_mod_evoWT_neg_1)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)
core_mod_evoWT_2 <-  bind_rows(list(big_mod_evoWT_pos,big_mod_evoWT_neg_2)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)

big_mod_unevo_pos <- filter(hubs_in_modu_unevo_pos, community==3)
big_mod_unevo_neg <- filter(hubs_in_modu_unevo_neg, community==1)
core_mod_unevo <-  bind_rows(list(big_mod_unevo_pos,big_mod_unevo_neg)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)

big_mod_mut_pos <- filter(hubs_in_modu_mut_pos, community==1)
big_mod_mut_neg <- filter(hubs_in_modu_mut_neg, community==1)
core_mod_mut <-  bind_rows(list(big_mod_mut_pos,big_mod_mut_neg)) %>% group_by(V, community) %>% filter(n()>1) %>%summarise(hub_score= sum(hub_score)/2)


core_in_big_mod_pos_and_neg <- data.frame(matrix(c(nrow(big_mod_WT_pos),nrow(big_mod_WT_neg),nrow(core_mod_WT),nrow(big_mod_unevo_pos),nrow(big_mod_unevo_neg),nrow(core_mod_unevo),nrow(big_mod_evo_pos),nrow(big_mod_evo_neg_1),nrow(core_mod_evo_1),nrow(big_mod_evo_pos),nrow(big_mod_evo_neg_2),nrow(core_mod_evo_2),nrow(big_mod_evoWT_pos),nrow(big_mod_evoWT_neg_1),nrow(core_mod_evoWT_1),nrow(big_mod_evoWT_pos),nrow(big_mod_evoWT_neg_2),nrow(core_mod_evoWT_2),nrow(big_mod_mut_pos),nrow(big_mod_mut_neg),nrow(core_mod_mut)), ncol=3, byrow = TRUE),row.names = c("WT","unevolved","evolved1","evolved2","evoWT1","evoWT2","mut")) %>%`colnames<-`(c("pos","neg","common"))

core_in_big_mod_pos_and_neg_long <- melt(t(core_in_big_mod_pos_and_neg))

ggplot(core_in_big_mod_pos_and_neg_long, aes(x=Var1, y=value, fill=Var1)) +geom_bar(stat="identity", position=position_dodge())+facet_grid(. ~ Var2) +labs(title="big module conservation ", x="pos/neg", y="Count")+scale_fill_brewer(palette="Set2")+  theme(axis.text.x = element_text(angle = 45))


#core of the big module-between bacteria types:
#positive
core_big_mod <- function(list_df){
  res <- as.data.frame(matrix(NA, nrow=length(list_df), ncol=length(list_df)))
  for (mod_num in c(1:length(list_df))){
    for (mod_num2 in c(1:length(list_df))){
      if (mod_num!=mod_num2){
    core_mod <-  bind_rows(list(list_df[[mod_num]],list_df[[mod_num2]])) %>% group_by(V) %>% filter(n()>1) %>%summarise(hub_score=sum(hub_score)/2)
    res[mod_num,mod_num2] =round(nrow(core_mod)/nrow(list_df[[mod_num]]), digits=2)
      }}}
  return (res)
}

list_bac <- list(big_mod_WT_pos,big_mod_unevo_pos,big_mod_evo_pos,big_mod_evoWT_pos,big_mod_mut_pos)
conserv<- core_big_mod(list_bac)%>%`row.names<-`(c("WT_in_core","unevo_in_core","evo_in_core","evoWT_in_core","mut_in_core"))%>%`colnames<-`(c("WT","unevo","evo","evoWT","mut"))

png("test.png",res=100)
p<-tableGrob(conserv)
grid.arrange(p)
dev.off()

big_core_sizes_pos <- data.frame(matrix(c(nrow(big_mod_WT_pos),nrow(big_mod_unevo_pos),nrow(big_mod_evo_pos),nrow(big_mod_evoWT_pos),nrow(big_mod_mut_pos)), ncol=1, byrow = TRUE),row.names = c("WT","unevolved","evolved","evoWT","mut")) %>%`colnames<-`("amount")

big_core_sizes_pos$bacteria = rownames(big_core_sizes_pos)%>% factor


ggplot(big_core_sizes_pos, aes(x=factor(bacteria, levels=c("WT","unevolved","evolved","evoWT","mut")), y=amount)) +geom_col(fill="lightblue",color="black")+ labs(title="Big Module Size", y="Amount", x="Bacteria Type")

#negative

list_bac <- list(big_mod_WT_neg,big_mod_unevo_neg,big_mod_evo_neg_1,big_mod_evo_neg_2,big_mod_evoWT_neg_1,big_mod_evoWT_neg_2,big_mod_mut_neg)
conserv<- core_big_mod(list_bac)%>%`row.names<-`(c("WT_in_core","unevo_in_core","evo1_in_core","evo2_in_core","evoWT1_in_core","evoWT2_in_core","mut_in_core"))%>%`colnames<-`(c("WT","unevo","evo1","evo2","evoWT1","evoWT2","mut"))

png("test.png",res=80)
p<-tableGrob(conserv)
grid.arrange(p)
dev.off()

big_core_sizes_neg <- data.frame(matrix(c(nrow(big_mod_WT_neg),nrow(big_mod_unevo_neg),nrow(big_mod_evo_neg_1),nrow(big_mod_evo_neg_2),nrow(big_mod_evoWT_neg_1),nrow(big_mod_evoWT_neg_2),nrow(big_mod_mut_neg)), ncol=1, byrow = TRUE),row.names = c("WT","unevolved","evo1","evo2","evoWT1","evoWT2","mut")) %>%`colnames<-`("amount")

big_core_sizes_neg$bacteria = rownames(big_core_sizes_neg)%>% factor

ggplot(big_core_sizes_neg, aes(x=factor(bacteria, levels=c("WT","unevolved","evo1","evo2","evoWT1","evoWT2","mut")), y=amount)) +geom_col(fill="lightblue",color="black")+ labs(title="Big Module Size", y="Amount", x="Bacteria Type")


```

plot the igraphs
```{r}

par(mar=c(0,0,0,0))

plot(WT_positive_p_igraph_df, vertex.size=5+hubs_in_modu_WT_pos$hub_score*5,vertex.label=NA,edge.width=1.5, vertex.color=hubs_in_modu_WT_pos$community)


par(mar=c(0,0,0,0))

plot(WT_negative_p_igraph_df, vertex.size=5+hubs_in_modu_WT_neg$hub_score*5,vertex.label=NA,edge.width=1.5, vertex.color=hubs_in_modu_WT_neg$community)

par(mar=c(0,0,0,0))

plot(evo_negative_p_igraph_df, vertex.size=5+hubs_in_modu_evo_neg$hub_score*5,vertex.label=NA,edge.width=1.5, vertex.color=hubs_in_modu_evo_neg$community)


```

